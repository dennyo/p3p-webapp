@using System.IO
@{ 
    Page.Title = "Add Robot";
    Layout = "~/_Layout.cshtml";
    int robotID = 0;
    var robotName = "";
    var robotText = "";
    var videoLink = "";
    var threeDlink = "";
    var codeLink = "";
    var codeSnippet = "";
    bool succesPhoto = false;

    if(IsPost)
    {
        Validation.RequireField("robotName", "You must provide a name for the robot");
        Validation.RequireField("robotText", "You must provide a description");
        if(Request.Files[0].FileName == string.Empty){Validation.AddFormError("You must attach at least one image");}
        else
        {
            if(!Request.Files[0].ContentType.StartsWith("image")){Validation.AddFormError("The given file is not an image");}
            if(Request.Files[0].ContentLength > 4000000){Validation.AddFormError("The file cannot exeed 4MB");}   
        }
        if(Request.Form["robotName"] != null) {robotName = Request.Form["robotName"];}
        if(Request.Form["robotText"] != null) {robotText = Request.Form["robotText"];} 
        if(Request.Form["videoLink"] != null) {videoLink= Request.Form["videoLink"];}
        if(Request.Form["threeDlink"] != null) {threeDlink= Request.Form["threeDlink"];}
        if(Request.Form["codeLink"] != null) {codeLink= Request.Form["codeLink"];}
        if(Request.Form["codeSnippet"] != null) {codeSnippet= Request.Form["codeSnippet"];}
        if(Validation.IsValid())
        {
            var db = Database.Open("basicData");
            db.Execute("INSERT INTO Robots (RobotName, RobotText) VALUES (@0,@1)", robotName, robotText);
            robotID = (int)db.GetLastInsertId();
            if(videoLink != "")
            {
                db.Execute("INSERT INTO VideoLinks (RobotId, Link) VALUES (@0,@1)", robotID, videoLink);
            }
            if(threeDlink != "")
            {
                db.Execute("INSERT INTO ThreeDFiles (RobotId, link) VALUES (@0,@1)", robotID, threeDlink);
            }
            if(codeLink != "")
            {
                db.Execute("INSERT INTO CodeLinks (RobotId, link) VALUES (@0,@1)", robotID, codeLink);
            }
            if(codeSnippet != "")
            {
                db.Execute("INSERT INTO CodeSnippets (RobotId, text) VALUES (@0,@1)", robotID, codeSnippet);
            }
            if(Request.Files.Count > 0)
            {
                var imageCount = Request.Files.Count;
                for(int i=0;i< imageCount;i++)
                {
                    var uploadedFile = Request.Files[i];
                    var fileName = Path.GetFileName(uploadedFile.FileName);
                    if(fileName != string.Empty)
                    {
                        var fileType = uploadedFile.ContentType;
                        if(fileType.StartsWith("image"))
                        {
                            var fileStream = uploadedFile.InputStream;
                            var fileLength = uploadedFile.ContentLength;
                            if(fileLength <= 4000000)
                            {
                                byte[] fileContent = new byte[fileLength];
                                fileStream.Read(fileContent, 0, fileLength);
                                db.Execute("INSERT INTO Photos (Photo, MimeType) VALUES (@0, @1)",fileContent, fileType);
                                int id = (int)db.GetLastInsertId();
                                db.Execute("INSERT INTO PhotoReference (RobotID, PhotoID) VALUES (@0,@1)", robotID, id );
                                if(i==0)
                                {
                                    db.Execute("UPDATE Robots SET PhotoID = @0 WHERE RobotID = @1", id, robotID);
                                }                         
                            }
                        }
                    } 
                }
                
            }
            else
            {
                db.Execute("UPDATE Robots SET PhotoID = @0 WHERE RobotID = @1", 1, robotID);
            }
            db.Close();
            Response.Redirect("~/Robot?Id=" + robotID);
        } 
    }
}

<div class="col-md-12">
<h1>Add a Robot</h1><span id="required">* Required Fields</span>
    <form id="robotform" method="post" enctype="multipart/form-data">
    <fieldset>
        @Html.ValidationSummary()
            <label for="robotName"><span class="glyphicon glyphicon-tag"></span>&nbsp;Name*</label> @Html.ValidationMessage("robotName")
            <input type="text" id="robotName" name="robotName" value="@robotName" class="form-control margin-btw" placeholder="Enter the name of the robot">
            <br />
            <label for="robotText"><span class="glyphicon glyphicon-pencil"></span>&nbsp;Description*</label> @Html.ValidationMessage("robotText")
            <textarea onkeyup="textCounter(this, 'counter',4000);" id="robotText" name="robotText" class="form-control" rows="8" placeholder="Provide a description for the robot">@robotText</textarea>
            <input disabled value="4000 characters left" id="counter">
            <br />
            <br />
            <label><span class="glyphicon glyphicon-picture"></span>&nbsp;Images*</label> @Html.ValidationMessage("Upload2") 
            <div class="margin-btw">
                @FileUpload.GetHtml(
                initialNumberOfFiles:1,
                allowMoreFilesToBeAdded:true,
                includeFormTag:false,
                uploadText: "Upload2",
                name: "Upload2")
            </div>
            <label for="videoLink"><span class="glyphicon glyphicon-film"></span> Embedded video link</label>
            <input type="text" id="videoLink" name="videoLink" value="@videoLink" class="form-control margin-btw" placeholder="e.g. https://youtube.com/embed/abCdeFg-123"> <br/>
            <label for="threeDlink"><span class="glyphicon glyphicon-link"></span> 3D model link</label>
            <input type="text" id="threeDlink" name="threeDlink" value="@threeDlink" class="form-control margin-btw" placeholder="e.g. https://360.autodesk.com/ViewerPage?id=abCdeFghijKlMnoP"> <br/>
            <label for="codeLink"><span class="glyphicon glyphicon-link"></span> Code link</label>
            <input type="text" id="codeLink" name="codeLink" value="@codeLink" class="form-control margin-btw" placeholder="e.g. https://github.com/username/repository"> <br />
            <label for="codeLink"><span class="glyphicon glyphicon-font"></span> Code Snippet</label>
            <textarea onkeyup="textCounter(this, 'counter2',4000);" id="codeSnippet" name="codeSnippet" class="form-control" rows="8" placeholder="Provide a description for the robot">@codeSnippet</textarea>
            <input disabled value="4000 characters left" id="counter2">
            <br />
            @*<input type="submit" name="buttonUpload2" value="Submit" class="btn btn-default" /> *@
            <button type="submit" name="buttonUpload2" class="btn btn-default">
                <span class="glyphicon glyphicon-save"></span> Upload
            </button>
            <input type="hidden" name="buttonUpload2"> <br /><br />
    </fieldset>
  </form>
</div>
                <script>
                function textCounter(field,field2,maxlimit)
                {
                 var countfield = document.getElementById(field2);
                 if ( field.value.length > maxlimit ) {
                  field.value = field.value.substring( 0, maxlimit );
                  return false;
                 } else {
                  countfield.value = maxlimit - field.value.length + " characters left";
                 }
                }
                </script>